name: Deploy to Azure

on:
  workflow_dispatch:
    inputs:
      deployGenAI:
        description: 'Deploy GenAI resources (Azure OpenAI and AI Search)'
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'

permissions:
  id-token: write
  contents: read

env:
  RESOURCE_GROUP: 'rg-expensemgmt-prod'
  LOCATION: 'uksouth'
  BASE_NAME: 'expensemgmt'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    environment: production
    outputs:
      webAppName: ${{ steps.deploy.outputs.webAppName }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Install sqlcmd
        run: |
          curl -sSL -o sqlcmd.tar.bz2 https://github.com/microsoft/go-sqlcmd/releases/download/v1.8.0/sqlcmd-linux-amd64.tar.bz2
          sudo tar -xjf sqlcmd.tar.bz2 -C /usr/local/bin
          sqlcmd --version

      - name: Deploy infrastructure
        id: deploy
        shell: pwsh
        run: |
          $deployGenAI = '${{ github.event.inputs.deployGenAI }}' -eq 'true'
          
          if ($deployGenAI) {
            Write-Host "Deploying with GenAI resources"
            ./deploy-infra/deploy.ps1 `
              -ResourceGroup "${{ env.RESOURCE_GROUP }}" `
              -Location "${{ env.LOCATION }}" `
              -BaseName "${{ env.BASE_NAME }}" `
              -DeployGenAI
          } else {
            Write-Host "Deploying without GenAI resources"
            ./deploy-infra/deploy.ps1 `
              -ResourceGroup "${{ env.RESOURCE_GROUP }}" `
              -Location "${{ env.LOCATION }}" `
              -BaseName "${{ env.BASE_NAME }}"
          }
          
          # Read deployment context
          $context = Get-Content .deployment-context.json | ConvertFrom-Json
          echo "webAppName=$($context.webAppName)" >> $env:GITHUB_OUTPUT

  deploy-application:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Wait for App Service to stabilize
        run: |
          echo "Waiting 60 seconds for App Service settings to apply..."
          sleep 60

      - name: Deploy application
        shell: pwsh
        run: |
          ./deploy-app/deploy.ps1

      - name: Run health check
        run: |
          webAppName="${{ needs.deploy-infrastructure.outputs.webAppName }}"
          appUrl="https://${webAppName}.azurewebsites.net"
          
          echo "Waiting for application to start..."
          sleep 30
          
          echo "Checking health endpoint..."
          status=$(curl -s -o /dev/null -w "%{http_code}" "${appUrl}/api/health" || echo "000")
          
          if [ "$status" = "200" ]; then
            echo "✓ Application is healthy"
          else
            echo "⚠ Health check returned status: $status"
          fi
          
          echo "Application URL: ${appUrl}/Index"
